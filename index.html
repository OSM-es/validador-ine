<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Validador INE</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha384-sHL9NAb7lN7rfvG5lfHpm643Xkcjzp4jFvuavGOndn6pjVqS6ny56CAt3nsEVT4H" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" integrity="sha384-pmjIAcz2bAn0xukfxADbZIb3t8oRT9Sv0rvO+BR5Csr6Dhqq+nZs59P0pPKQJkEV" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" integrity="sha384-wgw+aLYNQ7dlhK47ZPK7FRACiq7ROZwgFNg0m04avm4CaXS+Z9Y7nMu8yNjBKYC+" crossorigin="anonymous">

  <style type="text/css">
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    .leaflet-popup-content table td:first-child {
      font-weight: 600;
    }

    .leaflet-popup-content div {
      display: flex;
      justify-content: space-evenly;
    }

    .leaflet-remaining-items em{
      font-size: 1rem;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" integrity="sha384-eXVCORTRlv4FUUgS/xmOyr66XBVraen8ATNLMESp92FKXLAMiKkerixTiBvXriZr" crossorigin="anonymous"></script>
  <script type="module">
    const map = L.map('map', {
      center: [40.463667, -3.74922],
      zoom: 6
    });

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);

    const ign = L.tileLayer.wms('http://www.ign.es/wms-inspire/mapa-raster', {
      layers: 'mtn_rasterizado',
      format: 'image/png',
      transparent: true,
      attribution: 'Mapa ráster <a href="https://www.ign.es">Instituto Geográfico Nacional</a>'
    });

    const baseLayers = {
      "IGN": ign,
      "OpenStreetMap": osm
    };

    L.control.layers(baseLayers).addTo(map);

    const logo = L.control({ position: 'topleft' });
    logo.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');
      const url = "https://community.openstreetmap.org/t/proyecto-colaborativo-referencias-ine/7405"
      this._div.innerHTML = `<a class="leaflet-control-zoom-in" href="${url}" target="_blank" rel="noopener noreferrer">i</a>`;
      return this._div;
    }
    logo.addTo(map);

    fetch("./ES.geojson")
      .then(function (response) {
        return response.json();
      })
      .then(function (data) {
        const markers = L.markerClusterGroup();
        markers.addLayer(L.geoJson(data, {
          onEachFeature: function (feature, layer) {
            const { lat, lng } = layer.getLatLng()
            const buffer = layer.getLatLng().toBounds(1000)

            const editorId = `https://www.openstreetmap.org/edit?editor=id#map=19/${lat}/${lng}`
            const editorJosm = `http://127.0.0.1:8111/load_and_zoom?left=${buffer.getWest()}&bottom=${buffer.getSouth()}&right=${buffer.getEast()}&top=${buffer.getNorth()}`

            const links = `<div><a href="${editorId}" target="_blank" rel="noopener">iD</a><a href="${editorJosm}" target="remote">JOSM</a></div>`
            const table = `<table>${Object.entries(feature.properties).map(([k, v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join("")}</table>`
            layer.bindPopup(`${table}${links}`);
          }
        }));
        map.addLayer(markers);
        map.fitBounds(markers.getBounds());

        const remaining = L.control({ position: 'bottomleft' });
        remaining.onAdd = function (map) {
          this._div = L.DomUtil.create('div', 'leaflet-remaining-items');
          this._div.innerHTML = `Total: <em>${data.features.length}</em>`;
          return this._div;
        }
        remaining.addTo(map);
      });
  </script>
</body>

</html>